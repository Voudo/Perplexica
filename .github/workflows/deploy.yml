name: Deploy Perplexica

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if droplet exists
        id: droplet
        run: |
          IP=$(curl -sf -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?tag_name=perplexica" | \
            jq -r '[.droplets[0].networks.v4[] | select(.type=="public") | .ip_address][0] // empty')
          if [ -n "$IP" ] && [ "$IP" != "null" ]; then
            echo "ip=$IP" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if Terraform files changed
        id: tf_diff
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED=$(git diff HEAD~1 --name-only -- terraform/ | head -1)
          else
            CHANGED="initial"
          fi
          echo "changed=$( [ -n "$CHANGED" ] && echo true || echo false )" >> $GITHUB_OUTPUT

      # ── Terraform (only when droplet missing or .tf files changed) ──

      - name: Setup Terraform
        if: steps.droplet.outputs.exists != 'true' || steps.tf_diff.outputs.changed == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
          terraform_wrapper: false

      - name: Cache Terraform providers
        if: steps.droplet.outputs.exists != 'true' || steps.tf_diff.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: terraform/.terraform
          key: terraform-${{ hashFiles('terraform/.terraform.lock.hcl') }}

      - name: Terraform Init
        if: steps.droplet.outputs.exists != 'true' || steps.tf_diff.outputs.changed == 'true'
        working-directory: terraform
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Terraform Apply
        if: steps.droplet.outputs.exists != 'true' || steps.tf_diff.outputs.changed == 'true'
        working-directory: terraform
        run: terraform apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Get Droplet IP from Terraform
        if: steps.droplet.outputs.exists != 'true' || steps.tf_diff.outputs.changed == 'true'
        id: tf_ip
        working-directory: terraform
        run: echo "ip=$(terraform output -raw droplet_ip)" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      # ── Resolve IP from whichever source provided it ──

      - name: Resolve Droplet IP
        id: ip
        run: echo "value=${{ steps.droplet.outputs.ip || steps.tf_ip.outputs.ip }}" >> $GITHUB_OUTPUT

      # ── Deploy application ──

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.ip.outputs.value }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -e

            DEPLOYED_SHA=""
            [ -f /opt/perplexica/.deployed-sha ] && DEPLOYED_SHA=$(cat /opt/perplexica/.deployed-sha)
            if [ "$DEPLOYED_SHA" = "${{ github.sha }}" ]; then
              echo "=== Already running commit ${{ github.sha }}, nothing to do ==="
              exit 0
            fi

            if ! command -v docker &> /dev/null; then
              echo "=== Installing Docker ==="
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            fi

            if [ -d /opt/perplexica/.git ]; then
              cd /opt/perplexica
              git fetch origin
              git reset --hard origin/master
            else
              git clone https://github.com/${{ github.repository }} /opt/perplexica
            fi

            cd /opt/perplexica

            cat > .env <<EOF
            ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
            EOF

            NEW_HASH=$(sha256sum docker-compose.yml | cut -d' ' -f1)
            OLD_HASH=""
            [ -f .compose-hash ] && OLD_HASH=$(cat .compose-hash)
            if [ "$NEW_HASH" != "$OLD_HASH" ]; then
              echo "=== docker-compose.yml changed, pulling images ==="
              docker compose pull
              echo "$NEW_HASH" > .compose-hash
            else
              echo "=== docker-compose.yml unchanged, skipping pull ==="
            fi

            docker compose up -d --remove-orphans

            for i in $(seq 1 15); do
              docker compose exec -T ollama ollama list >/dev/null 2>&1 && break
              sleep 2
            done

            if ! docker compose exec -T ollama ollama list 2>/dev/null | grep -q nomic-embed-text; then
              echo "=== Pulling nomic-embed-text ==="
              docker compose exec -T ollama ollama pull nomic-embed-text
            fi

            for i in $(seq 1 30); do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "=== Perplexica is up ==="
                break
              fi
              [ "$i" -eq 30 ] && echo "WARNING: health check timed out"
              sleep 2
            done

            echo "${{ github.sha }}" > /opt/perplexica/.deployed-sha
            docker compose ps

      - name: Print app URL
        run: |
          echo "Perplexica API is live at:"
          echo "http://${{ steps.ip.outputs.value }}:3000/api/search"
