name: Deploy Perplexica

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

jobs:
  provision:
    name: Provision Droplet (skips if already exists)
    runs-on: ubuntu-latest
    outputs:
      droplet_ip: ${{ steps.tf_output.outputs.droplet_ip }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Get Droplet IP
        id: tf_output
        working-directory: terraform
        run: echo "droplet_ip=$(terraform output -raw droplet_ip)" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: provision

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for SSH to be ready
        run: |
          echo "Waiting for droplet to be SSH-ready..."
          SSH_READY=false
          for i in $(seq 1 20); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
              -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
              root@${{ needs.provision.outputs.droplet_ip }} echo "ready" 2>/dev/null; then
              echo "SSH is ready"
              SSH_READY=true
              break
            fi
            echo "Attempt $i/20 failed, retrying in 15s..."
            sleep 15
          done
          if [ "$SSH_READY" != "true" ]; then
            echo "SSH never became ready after 20 attempts"
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.provision.outputs.droplet_ip }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            set -e

            if ! command -v docker &> /dev/null; then
              echo "=== Installing Docker ==="
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            else
              echo "=== Docker already installed ==="
            fi

            if [ -d /opt/perplexica/.git ]; then
              echo "=== Updating repo ==="
              cd /opt/perplexica
              git fetch origin
              git reset --hard origin/master
            else
              echo "=== Cloning repo ==="
              git clone https://github.com/${{ github.repository }} /opt/perplexica
              cd /opt/perplexica
            fi

            cd /opt/perplexica

            echo "=== Writing .env ==="
            cat > .env <<EOF
            ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
            EOF

            echo "=== Pulling Docker images ==="
            docker compose -f docker-compose.yml pull

            echo "=== Starting services ==="
            docker compose -f docker-compose.yml up -d --remove-orphans

            echo "=== Ensuring nomic-embed-text is available ==="
            sleep 10
            docker compose -f docker-compose.yml exec -T ollama ollama pull nomic-embed-text

            echo "=== Waiting for Perplexica to be healthy ==="
            for i in $(seq 1 12); do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "Perplexica is up!"
                break
              fi
              echo "Attempt $i/12, retrying in 10s..."
              sleep 10
            done

            echo "=== Deploy complete ==="
            docker compose -f docker-compose.yml ps

      - name: Print app URL
        run: |
          echo "Perplexica API is live at:"
          echo "http://${{ needs.provision.outputs.droplet_ip }}:3000/api/search"
