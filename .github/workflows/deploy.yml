name: Deploy Perplexica

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

jobs:
  provision:
    name: Provision Droplet (skips if already exists)
    runs-on: ubuntu-latest
    outputs:
      droplet_ip: ${{ steps.tf_output.outputs.droplet_ip }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
          terraform_wrapper: false

      - name: Seed tfstate if missing or invalid
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          set -x
          ENDPOINT="https://nyc3.digitaloceanspaces.com"
          BUCKET="perplexica-tfstate"
          KEY="terraform.tfstate"
          SEED='{"version":4,"terraform_version":"1.0.0","serial":0,"lineage":"","outputs":{},"resources":[]}'

          echo "=== Deleting existing (possibly corrupt) state file ==="
          aws s3 rm "s3://${BUCKET}/${KEY}" --endpoint-url "$ENDPOINT" || true

          echo "=== Uploading valid empty state ==="
          echo "$SEED" > /tmp/tfstate-seed
          cat /tmp/tfstate-seed
          aws s3api put-object \
            --bucket "$BUCKET" \
            --key "$KEY" \
            --body /tmp/tfstate-seed \
            --content-type "application/json" \
            --endpoint-url "$ENDPOINT"

          echo "=== Verifying upload ==="
          aws s3api get-object \
            --bucket "$BUCKET" \
            --key "$KEY" \
            --endpoint-url "$ENDPOINT" \
            /tmp/tfstate-verify
          echo "Downloaded content:"
          cat /tmp/tfstate-verify
          echo ""
          echo "Byte count: $(wc -c < /tmp/tfstate-verify)"

      - name: Terraform Init
        working-directory: terraform
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Import existing resources
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}
        run: |
          KEY_ID=$(curl -sf -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/account/keys" | \
            jq -r '.ssh_keys[] | select(.name == "perplexica-deploy-key") | .id // empty')
          if [ -n "$KEY_ID" ]; then
            echo "Importing SSH key $KEY_ID"
            terraform import digitalocean_ssh_key.perplexica "$KEY_ID" || true
          fi

          DROPLET_ID=$(curl -sf -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets?tag_name=perplexica" | \
            jq -r '.droplets[0].id // empty')
          if [ -n "$DROPLET_ID" ] && [ "$DROPLET_ID" != "null" ]; then
            echo "Importing droplet $DROPLET_ID"
            terraform import digitalocean_droplet.perplexica "$DROPLET_ID" || true
          fi

          FW_ID=$(curl -sf -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/firewalls" | \
            jq -r '.firewalls[] | select(.name == "perplexica-firewall") | .id // empty')
          if [ -n "$FW_ID" ]; then
            echo "Importing firewall $FW_ID"
            terraform import digitalocean_firewall.perplexica "$FW_ID" || true
          fi

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Get Droplet IP
        id: tf_output
        working-directory: terraform
        run: echo "droplet_ip=$(terraform output -raw droplet_ip)" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: provision

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.provision.outputs.droplet_ip }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            set -e

            if ! command -v docker &> /dev/null; then
              echo "=== Installing Docker ==="
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            else
              echo "=== Docker already installed ==="
            fi

            if [ -d /opt/perplexica/.git ]; then
              echo "=== Updating repo ==="
              cd /opt/perplexica
              git fetch origin
              git reset --hard origin/master
            else
              echo "=== Cloning repo ==="
              git clone https://github.com/${{ github.repository }} /opt/perplexica
              cd /opt/perplexica
            fi

            cd /opt/perplexica

            echo "=== Writing .env ==="
            cat > .env <<EOF
            ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
            EOF

            echo "=== Pulling Docker images ==="
            docker compose -f docker-compose.yml pull

            echo "=== Starting services ==="
            docker compose -f docker-compose.yml up -d --remove-orphans

            echo "=== Ensuring nomic-embed-text is available ==="
            sleep 10
            docker compose -f docker-compose.yml exec -T ollama ollama pull nomic-embed-text

            echo "=== Waiting for Perplexica to be healthy ==="
            for i in $(seq 1 12); do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "Perplexica is up!"
                break
              fi
              echo "Attempt $i/12, retrying in 10s..."
              sleep 10
            done

            echo "=== Deploy complete ==="
            docker compose -f docker-compose.yml ps

      - name: Print app URL
        run: |
          echo "Perplexica API is live at:"
          echo "http://${{ needs.provision.outputs.droplet_ip }}:3000/api/search"
